# 性能优化

## 网络加载

1. 减少 HTTP 资源请求次数

> comb，请求资源合并

2. 减小 HTTP 请求大小

> 压缩

3. 将 CSS 或 JavaScript 放到外链中

> 可做 `comb` 合并打包、可缓存静态资源

4. 避免页面中空的 href 和 src

> 当 `link` 标签的 `href` 属性为空，或 `script`、`img`、`iframe` 标签的 `src` 属性为空时，浏览器在渲染的过程中仍会将 `href` 属性或 `src` 属性中的空内容进行加载，直至加载失败，这样就阻塞了页面中其他资源的下载进程

5. 页面缓存，静态站点还可缓存 HTML 文件

```txt
强制缓存：缓存匹配成功后，直接使用缓存数据；status 为 200，size 为 （from disk cache）
判断缓存是否失效：Expires/Cache-Control
Cache-Control：设置为 no-cache 会开启协商缓存，设置为 no-store 就不会进行任何缓存(强制、协商均无效)

协商缓存：缓存匹配成功后，把缓存信息带到新的资源请求中；如果服务器判断为未修改，status 为 304，size 为服务器返回的少许的头部数据大小，然后直接使用本地缓存使用
判断缓存是否失效：Last-Modified / If-Modified-Since、Etag / If-None-Match
```

6. CDN、ISP、网关、反代 等缓存手段

7. 离线缓存

> 可以通过 manifest 做到应用级的缓存，让用户离线也可加载网页。可参考 `PWA`

8. Get 幂等性异步操作时，缓存请求数据

> 除了静态资源外，对数据不影响的操作请求中，可缓存服务端返回的数据

9. 减少页面重定向

> 每次重定向都将导致更长的等待延时

10. 静态资源分域来增加下载并行数

> 浏览器在同一时刻向同一个域名请求文件的并行下载数是有限的，因此可以利用多个域名的主机来存放不同的静态资源，增大页面加载时资源的并行下载数，缩短页面资源加载的时间

11. 减少 Cookie 的大小并进行 Cookie 隔离

> HTTP 请求通常默认带上浏览器端的 Cookie 一起发送给服务器，所以在非必要的情况下，要尽量减少 Cookie 来减小 HTTP 请求的大小。对于静态资源，尽量使用不同的域名来存放，因为 Cookie 默认是不能跨域的，这样就做到了不同域名下静态资源请求的 Cookie 隔离

12. 异步加载 JavaScript 资源

```txt
JavaScript 在渲染该 script 标签之后的文档元素之前：
默认：浏览器会立即加载并执行指定的脚本
async：加载和渲染后续文档元素的过程将和 script 的加载与执行并行进行
defer：加载后续文档元素的过程将和 script 的加载并行进行，但是该脚本的执行要在所有元素解析完成之后，DOMContentLoaded 事件触发之前完成
```

13. 避免使用 @import 引用加载 CSS

> 这样会增加 CSS 资源加载的关键路径长度，带有 ＠import 的 CSS 样式需要在 CSS 文件串行解析到 @import 时才会加载另外的 CSS 文件，大大延后 CSS 渲染完成的时间

14. 图片的懒加载和 base64 等处理

## 页面渲染

1. 重排和重绘

```txt
一个页面载入成功以后形成两个内部数据结构，一个是 dom 树（记录页面中的 dom 节点结构），一个是渲染树（控制节点如何渲染）。所有引起页面几何属性（宽高）改变的的操作都会引起页面的重新计算，这将改变 dom 树（重排），引起页面重排，最后进行重绘；而比如页面颜色的改变等外观上的变化，也将单独引起页面的重绘
eg. 预设定图片大小，防止加载完后重新绘制；DOM 的批量操作进行 batch 或者显隐处理；谨慎使用 JS 和 CSS 动画
```

2. 尽早加载 CSS 渲染页面，并减少 JS 的阻塞

> JavaScript 默认的加载和解析执行对页面渲染造成阻塞，应该放到底部加载或者增加 defer/async 属性

3. 减少 DOM 元素数量和深度

> HTML 中标签元素越多，标签的层级越深，浏览器解析 DOM 并绘制到浏览器中所花的时间就越长

4. CSS 选择符

```txt
尽量避免在选择器末尾添加通配符: CSS 解析匹配到 渲染树的过程是从右到左的逆向匹配，在选择器末尾添加通配符至少会增加一倍多计算量
减少使用关系型样式表的写法: 直接使用唯一的类名即可最大限度的提升渲染引擎绘制渲染树等效率
```

5. 避免使用 CSS 表达式或 CSS 滤镜

```css
滤镜：filter : progid : DXImageTransform.Microsoft.Alpha( opacity = 50 )；解析速度差
表达式：zoom: expression(...)；会反复执行，严重影响效率
```

6. 高频发操作的截流和去抖动

```txt
Throttle: 设置固定的函数执行速率，从而降低频繁事件回调的执行次数
Debounce: 繁事件的回调函数在某段连续时间内，在事件触发后只执行一次
```

## 架构

1. 尝试使用 SPDY 和 HTTP2

2. 服务端渲染

3. 项目中使用 VirtualDom
